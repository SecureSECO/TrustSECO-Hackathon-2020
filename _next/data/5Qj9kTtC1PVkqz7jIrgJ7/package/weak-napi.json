{"pageProps":{"postData":{"_id":"5fb667299f9e7f16fd3248ea","id":"weak-napi","crawlTimestamp":"19/11/2020 12:38:00","packageName":"weak-napi","description":"Make weak references to JavaScript Objects.","repository":{"type":"git","url":"git://github.com/node-ffi-napi/weak-napi.git"},"readme":"weak-napi\n=========\n### Make weak references to JavaScript Objects.\n\n[![Greenkeeper badge](https://badges.greenkeeper.io/node-ffi-napi/weak-napi.svg)](https://greenkeeper.io/)\n\n[![NPM Version](https://img.shields.io/npm/v/weak-napi.svg?style=flat)](https://npmjs.org/package/weak-napi)\n[![NPM Downloads](https://img.shields.io/npm/dm/weak-napi.svg?style=flat)](https://npmjs.org/package/weak-napi)\n[![Build Status](https://travis-ci.org/node-ffi-napi/weak-napi.svg?style=flat&branch=master)](https://travis-ci.org/node-ffi-napi/weak-napi?branch=master)\n[![Coverage Status](https://coveralls.io/repos/node-ffi-napi/weak-napi/badge.svg?branch=master)](https://coveralls.io/r/node-ffi-napi/weak-napi?branch=master)\n[![Dependency Status](https://david-dm.org/node-ffi-napi/weak-napi.svg?style=flat)](https://david-dm.org/node-ffi-napi/weak-napi)\n\nOn certain rarer occasions, you run into the need to be notified when a JavaScript\nobject is going to be garbage collected. This feature is exposed to V8's C++ API,\nbut not to JavaScript.\n\nThat's where `weak-napi` comes in! This module exports the JS engine's GC tracking\nfunctionality to JavaScript. This allows you to create weak references, and\noptionally attach a callback function to any arbitrary JS object. The callback\nfunction will be invoked right after the Object is garbage collected (i.e. after\nthere are no more remaining references to the Object in JS-land).\n\nThis module can, for example, be used for debugging; to determine whether or not\nan Object is being garbage collected as it should.\nTake a look at the example below for commented walkthrough scenario.\n\n\nInstallation\n------------\n\nInstall with `npm`:\n\n``` bash\n$ npm install weak-napi\n```\n\nDifferences from node-weak\n--------------------------\n\nThis module exports the full `node-weak` API. The main differences are:\n\n- This module uses N-API! Yay. That’s a good thing – you don’t need to worry\n  about re-compiling your code anymore when upgrading Node.\n- GC callbacks are invoked at a suitable time (after the actual GC run has\n  finished). **This is nice because it means your process won’t\n  potentially crash.**\n- This module works on Node 6+ only, since it uses a `Proxy` object to give a\n  more complete referral of properties.\n- `isNearDeath()` is not supported (always returns false).\n\nThat’s it!\n\nExample\n-------\n\nHere's an example of calling a `cleanup()` function on a Object after it gets\ngarbage collected:\n\n``` js\nvar weak = require('weak-napi')\n\n// we are going to \"monitor\" this Object and invoke \"cleanup\"\n// before the object is garbage collected\nvar obj = {\n    a: true\n  , foo: 'bar'\n}\n\n// Here's where we set up the weak reference\nvar ref = weak(obj, function () {\n  // `this` inside the callback is the EventEmitter.\n  console.log('\"obj\" has been garbage collected!')\n})\n\n// While `obj` is alive, `ref` proxies everything to it, so:\nref.a   === obj.a\nref.foo === obj.foo\n\n// Clear out any references to the object, so that it will be GC'd at some point...\nobj = null\n\n//\n//// Time passes, and the garbage collector is run\n//\n\n// `callback()` above is called, and `ref` now acts like an empty object.\ntypeof ref.foo === 'undefined'\n```\n\n\nWeak Callback Function \"Best Practices\"\n---------------------------------------\n\nIt's important to be careful when using the \"callbacks\" feature of `weak-napi`,\notherwise you can end up in a situation where the watched object will never\nbe garbage collected.\n\nYou _should **not**_ define the callback function in the same scope as the\nobject that is being watched. It's often best to define the callback function\nat the highest scope possible (top-level being the best). Named functions\nwork really well for this:\n\n``` js\nvar http = require('http')\n  , weak = require('weak-napi')\n\nhttp.createServer(function (req, res) {\n  weak(req, gcReq)\n  weak(res, gcRes)\n  res.end('Hello World\\n')\n}).listen(3000)\n\nfunction gcReq () {\n  console.log('GC\\'d `req` object')\n}\n\nfunction gcRes () {\n  console.log('GC\\'d `res` object')\n}\n```\n\n\nAPI\n---\n\n### Weakref weak(Object obj [, Function callback])\n\nThe main exports is the function that creates the weak reference.\nThe first argument is the Object that should be monitored.\nThe Object can be a regular Object, an Array, a Function, a RegExp, or any of\nthe primitive types or constructor function created with `new`.\n\nOptionally, you can set a callback function to be invoked\nbefore the object is garbage collected.\n\n\n### Object weak.get(Weakref ref)\n\n`get()` returns the actual reference to the Object that this weak reference was\ncreated with. If this is called with a dead reference, `undefined` is returned.\n\n\n### Boolean weak.isDead(Weakref ref)\n\nChecks to see if `ref` is a dead reference. Returns `true` if the original Object\nhas already been GC'd, `false` otherwise.\n\n\n### Boolean weak.isNearDeath(Weakref ref)\n\n*Note* The N-API port of this module does not implement this and\nalways returns `false`.\n\n\n### Boolean weak.isWeakRef(Object obj)\n\nChecks to see if `obj` is \"weak reference\" instance. Returns `true` if the\npassed in object is a \"weak reference\", `false` otherwise.\n\n\n### EventEmitter weak.addCallback(Weakref ref, Function callback)\n\nAdds `callback` to the Array of callback functions that will be invoked before the\nObject gets garbage collected. The callbacks get executed in the order that they\nare added.\n\n\n### EventEmitter weak.removeCallback(Weakref ref, Function callback)\n\nRemoves `callback` from the Array of callback functions that will be invoked before\nthe Object gets garbage collected.\n\n\n### EventEmitter weak.removeCallbacks(Weakref ref)\n\nEmpties the Array of callback functions that will be invoked before the Object gets\ngarbage collected.\n\n\n### Array weak.callbacks(Weakref ref)\n\nReturns an Array that `ref` iterates through to invoke the GC callbacks. This\nutilizes node's `EventEmitter#listeners()` function and therefore returns a copy\nin node 0.10 and newer.\n","homepage":"https://github.com/node-ffi-napi/weak-napi#readme","trustScore":17,"sourceRank":{"basic_info_present":1,"repository_present":1,"readme_present":1,"license_present":1,"versions_present":1,"follows_semver":1,"recent_release":1,"not_brand_new":1,"one_point_oh":1,"dependent_projects":4,"dependent_repositories":2,"stars":1,"contributors":1,"subscribers":0,"all_prereleases":0,"any_outdated_dependencies":0,"is_deprecated":0,"is_unmaintained":0,"is_removed":0,"trustScore":17},"versions":[{"versionNumber":"1.0.0","timestamp":"2017-11-17T01:03:53.675Z","trustScore":8,"dependencies":[{"packageName":"bindings","version":"^1.3.0"},{"packageName":"node-addon-api","version":"https://github.com/nodejs/node-addon-api/archive/82656bb.tar.gz"}]},{"versionNumber":"1.0.1","timestamp":"2017-11-24T02:55:04.846Z","trustScore":7,"dependencies":[{"packageName":"bindings","version":"^1.3.0"},{"packageName":"node-addon-api","version":"^1.1.0"},{"packageName":"setimmediate-napi","version":"^1.0.3"}]},{"versionNumber":"1.0.2","timestamp":"2018-01-02T19:50:42.869Z","trustScore":8,"dependencies":[{"packageName":"bindings","version":"^1.3.0"},{"packageName":"node-addon-api","version":"^1.1.0"},{"packageName":"setimmediate-napi","version":"^1.0.3"}]},{"versionNumber":"1.0.3","timestamp":"2019-04-10T11:24:15.597Z","trustScore":8,"dependencies":[{"packageName":"bindings","version":"^1.3.0"},{"packageName":"node-addon-api","version":"^1.1.0"},{"packageName":"setimmediate-napi","version":"^1.0.3"}]},{"versionNumber":"2.0.0","timestamp":"2020-04-22T19:42:32.323Z","trustScore":14,"dependencies":[{"packageName":"node-addon-api","version":"github:nodejs/node-addon-api#fedc8195e3a33e32a8a6b4f8b8285cdc6a104a44"},{"packageName":"setimmediate-napi","version":"^1.0.3"},{"packageName":"node-gyp-build","version":"^4.2.1"}]},{"versionNumber":"2.0.1","timestamp":"2020-05-05T13:16:17.012Z","trustScore":12,"dependencies":[{"packageName":"node-addon-api","version":"^3.0.0"},{"packageName":"node-gyp-build","version":"^4.2.1"},{"packageName":"setimmediate-napi","version":"^1.0.3"}]},{"versionNumber":"2.0.2","timestamp":"2020-05-29T17:26:20.330Z","trustScore":17,"dependencies":[{"packageName":"node-addon-api","version":"^3.0.0"},{"packageName":"node-gyp-build","version":"^4.2.1"},{"packageName":"setimmediate-napi","version":"^1.0.3"}]}]}},"__N_SSG":true}